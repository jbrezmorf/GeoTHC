\documentclass[11pt]{report}

\usepackage{helvet}
\renewcommand{\familydefault}{\sfdefault}
\renewcommand{\rmdefault}{\sfdefault}

\usepackage[utf8]{inputenc}
\usepackage[czech]{babel}
\usepackage{amsfonts,amsmath}
\usepackage{etoolbox}
\usepackage{graphicx}
% \usepackage{hyperref}
\usepackage{multirow}
\usepackage{titlesec}
\setcounter{secnumdepth}{3}

\usepackage{fancyhdr}
\pagestyle{fancy}
\lhead{
    \begin{picture}(0,0)
        \put(-60,0){\includegraphics{TACR_logo.png}}
    \end{picture}
    }
\rhead{}
\renewcommand{\headrulewidth}{0pt}

\usepackage[total={8.27in, 11.60in}, left=0.82in, right=0.82in,%
top=1.49in, bottom=1.49in]{geometry}

% macro for units.
\def\UNIT#1#2{\ifstrempty{#2}{}{%
\ifstrequal{#2}{1}{\mathrm{#1}}{\mathrm{#1}^{#2}}%
}}
\def\units#1#2#3{\ifstrempty{#1#2#3}{$[-]$}{$[ \UNIT{kg}{#1}\UNIT{m}{#2}\UNIT{s}{#3} ]$}} %with brackets
\def\unitss#1#2#3{\ifstrempty{#1#2#3}{$-$}{$ \UNIT{kg}{#1}\UNIT{m}{#2}\UNIT{s}{#3} $}}    %without brackets

%macro for hyperlinks (dummy)
\def\hyperA#1#2{#2}



% ***************************************** SYMBOLS
\def\abs#1{\lvert#1\rvert}
\def\argdot{{\hspace{0.18em}\cdot\hspace{0.18em}}}
\def\avg#1{\left\{#1\right\}}
\def\bb{\vc b}
\def\d{\mathrm{d}}
\def\D{{\tn D}}
\def\div{\operatorname{div}}
\def\Eh{\mathcal E_h}       % edges of \Th
\def\Ehb{\mathcal E_{h,B}}  % edges of \Th on boundary
\def\Ehcom{\mathcal E_{h,C}}         % edges of \Th on interface with lower dimension
\def\Ehdir{\mathcal E_{h,D}}         % Dirichlet edges of \Th
\def\Ehint{\mathcal E_{h,I}}       % interior edges of \Th
\def\Ehneu{\mathcal E_{h,N}}         % Neumann or Robin edges of \Th
\def\grad{\nabla}
\def\jmp#1{[#1]}
\def\n{\vc n}
\def\nn{\vc n}
\def\prtl{\partial}
\def\R{\mathbb R}
\def\Real{\mathbb R}
\def\sc#1#2{\left(#1,#2\right)}
\def\Th{\mathcal T_h}       % triangulation
\def\th{\vartheta}
\def\tn#1{{\mathbb{#1}}}    % tensor
\def\Tr{\operatorname{Tr}}
\def\vc#1{\mathbf{\boldsymbol{#1}}}     % vector
\def\wavg#1{\avg{#1}_\omega}
\def\where{\,|\,}
%***************************************************************************





\begin{document}


%\ULCornerWallPaper{1}{\includegraphics{TACR_logo.png}}
%\LLCornerWallPaper{1}{bar}
%\lipsum[1-3]

\title{Závěrečná zpráva projektu GeoTHC}
\maketitle
\chapter{A}
\chapter{B}
\chapter{C}

\pagebreak
\section{Vývoj numerického software Flow123d}
Program Flow123d je softwarový nástroj pro simulaci termálních, hydrologických 
a chemických (THC) procesů v rozpukaném porézním prostředí. Podporovné 
fyzikální modely zahrnují: Darcyovské proudění, transport látek, jejich reakce, 
fyzikální a chemické interakce s horninou a vedení tepla. Program je schopen 
popsat explicitně procesy v 3D médiu, 2D puklinách, a 1D preferenčních cestách a 
komunikaci mezi těmito doménami různých dimenzí. Tento přístup umožňuje výpočty 
v regionálním měřítku se zahrnutím vlivu jemných struktur s výrazně odlišnými 
materiálovámi parametry, např. geologických zlomů. Zejména je vhodný pro  
modelování transportních procesů v žulových masivech s komplexních geologickou 
strukturou.  

\subsection{Přehled vývoje v průběhu projektu}

\subsubsection{Počáteční stav}
Prvotní verze programu vznikla v rámci dizertační práce 
Otto Severýna okolo roku 2004. Program umožňoval výpočet stacionárního 
Darcyovského proudění pomocí metody smíšených-hybridních konečných prvků 
nultého řádu. Originalita nespočívala v komplexnosti řešené rovnice (jedná o 
lineární eliptickou rovnici), ale v komplexnosti výpočetní oblasti. Program 
umožňuje modelovat 3D kontinuum obsahující relativně tenké 2D pukliny a 1D 
kanály pomocí 2D a 1D konečných prvků a řeší tak sdruženou úlohu jedné rovnice 
proudění na výpočetních oblastech různé dimenze. Později byl program významně 
rozšířen.

Ke konci roku 2010 umožňoval software výpočet stacionárního proudění a 
navazující výpočet transportu. 

Lineární systém algebraických rovnic vyplývající 
ze smíšené-hybridní diskretizace problému proudění byl řešen paralelně pomocí 
knihovny PETSc. Byla implementována paralelní redukce soustavy pomocí 
Schurových doplňků a redukovaný systém s pozitivně definitní maticí byl řešen 
metodou sdružených gradientů s možností široké škály předpodmiňovačů dostupných 
přes rozhraní knihovny PETSc. Transportní rovnice (pouze konvekce bez difúze) 
zahrnovala koncept duální porozity (mobilní a immobilní póry) a sorpci látky 
do horniny. Bylo možno řešit transport více látek najednou. Transportní rovnice 
byla řešena explicitní Eulerovou metodou a metodou konečných objemů s upwindem.  
Výpočet jednoho časového kroku byl realizován paralelně pomocí maticového 
násobení knihovny PETSc. 

Vstupní data programu byla zadávána v několika 
souborech s rozdílným formátem. Pro jejich přípravu bylo třeba použít 
další podpůrné softwarové nástroje což značně komplikovalo jakoukoliv 
jejich změnu. Výstup výsledných skalárních a vektorových 
polí byl realizován pouze do formátu programu GMSH, který není podporován jiným 
vizualizačním software. K dispozici byla elementární dokumentace vstupních 
souborů. Software měl již vlastni SVN repozitář pro správu verzí a webové 
stránky projektu. Bylo vytvořeno několik testů pro ověření základní 
funkcionality. 


\subsubsection{2011 -- verze 1.6.5}
Byly rozpracovány třídy pro řešení rovnice konvekce-difúze pomocí nespojité 
Galerkinovy metody s implicitní časovou diskretizací. Byl implementován model 
pro rozpady a jednosložkové reakce. Byla vytvořena třída pro obecné sekvenciální 
propojení rovnic (proudění ustálené i neustálené a transportu). Do modelu 
transportu byly implementovány dva typy objemových zdrojů koncentrací 
transportovaných veličin. Byla také přidána možnost zadávat časově závislé 
okrajové podmínky transportu.
Byla implementována numerická metoda „lumped mixed-hybrid“ pro neustálené 
proudění, která, na rozdíl od klasické smíšené-hybridní metody, splňuje při 
řešení evolučních úloh diskrétní princip maxima. Porušení principu maxima přitom 
může vést na nefyzikální překmity a oscilace. Při iteračním řešení nelineárních 
či sdružených úloh pak může vést k problémům s konvergencí.
Byly testovány dvě metody propojení rovnic proudění na nekompatibilních 2D a 1D 
sítích při spojitém tlaku. Pro obě byla ověřena konvergence k odvozenému 
analytickému řešení.
Použití metody BDDC bylo úspěšně testováno na úlohách stacionárního proudění na 
sítích s prvky více dimenzí. Její hlavní výhodou je velmi dobrá škálovatelnost a 
tedy možnost řešení velmi rozsáhlých úloh. Metoda se zdá výhodná i kvůli tomu, 
že není nutná samostatná konstrukce Schurových doplňků ke zmenšení velikosti 
systému, neboť proměnné eliminované při použití Schurových doplňků jsou 
samostatně eliminovány na jednotlivých subdoménách.
Bylo vytvořeno jednotné výstupní rozhraní pro výstup skalárních a vektorových 
polí do formátu GMSH nebo formátů VTK. Nové rozhraní je nyní použito pro výstup 
všech datových polí. Dále bylo navrženo a částečně implementováno vstupní 
rozhraní a byla vytvořena podrobná specifikace nových vstupních souborů. 
Byla rozšířena a zkvalitněna sada testovacích úloh a vytvořen sytém pro 
automatické spouštění testů a porovnávání vůči referenčním výsledkům. Testovací 
sada je automaticky spouštěna pro každou změnu zdrojových kódů a výsledky jsou 
publikovány na webu projektu. 

\subsubsection{2012 -- verze 1.7.0}
Byla dokončena implementace modelu pro advekci a difúzi s zahrnutím 
hydrodynamické disperze. Model používá nespojitou Galerkinovu metodu pro 
diskretizaci v prostoru a implicitní Eulerovu metodu pro časovou integraci.  
Pole koncentrací je diskretizováno pomocí po částech lineárních funkcí na 
jednotlivých elementech (čtyřstěnech, trojúhelnících, či úsečkách), spojitost 
řešení je vynucena penalizačním členem ve slabé formulaci řešené rovnice. Model 
byl odladěn na několika testovacích úlohách, je podporováno parallelní 
sestavování matic i a parallelní řešení soustav na jednotlivých časových 
úrovních.
Bylo optimalizováno a zjednodušeno uložení výpočetní sítě a nástroj ngh pro 
hledání sousedností mezi dimenzemi byl začleněn přímo do Flow123d. Vyhledávání 
kompatibliních sousedností probíhá přímo na načtené výpočetní síti což je 
rychlejší a zmenšuje paměťové nároky. 
Dále bylo dokončeno a aplikováno nové vstupní rozhraní. Veškeré vstupy programu 
jsou nyní čteny přes toto rozhraní, které umožňuje automatické vytvoření 
referenční dokumentace hlavního vstupního souboru ve formátu JSON.
Byly navrhnuty a implementovány třídy pro zadávání časo-prostorových skalárních, 
vektorových či tenzorových polí. Většinu parametrů v modelech lze nyní zadávat 
jednotným způsobem. Pro parametr zadávaný pomocí „Field“ rozhraní, lze pro každý 
region sítě předepsat prostorovou závislost pomocí jednoho ze šesti 
elementárních funkcí. Elementární funkce FieldConstant poskytuje prostorově 
konstantní hodnoty, FieldFormula umožňuje zadat funkci pomocí vzorce 
obsahujícího parametry t,x,y,z, který je přeložen až při běhu programu, 
FieldPython umožňuje výpočet hodnot pomocí programu v jazyce Python, 
FieldElementwise slouží k zadání po částech konstantní diskrétní funkce na 
stejné síti jaká se použije k diskretizaci rovnice jíž je funkce parametrem, a 
konečně FieldInterpolated umožňuje interpolovat hodnotu z po částech konstantní 
diskrétní funkce na jiné síti. 
Poslední zmíněná elementární funkce umožňuje interpolace prostorových dat jedné 
sítě na data okrajových podmínek na jiné síti. Pro efektivní vyhledávání 3D 
elementů protínajících 2D a 1D prvky hranice byla implementována metoda  
„Bounding interval hierarchy“. Též bylo nutné implementovat funkce pro výpočet 
průniku s nalezenými 3D elementy.
 Během roku 2012 bylo začleněno přes 500 sad změn. 
\subsubsection{2013 -- verze 1.8.0}
Verze 1.7.0 z předchozího roku přinesla dvě velké změny: nový model 
advekce-difúze a nové vtupní rozhraní. Obě přinesly rozšíření možností 
simulátoru, ale zároveň mohlo dojít ke zhoršení výkonu. V roce 2013 bylo 
provedeno podrobné porovnání výsledků a výkonu oproti verzi 1.6.7 na reálných 
úlohách, byly opraveny drobné chyby a vyřešeny podstatné výkonnostní problémy.  
Nové funkcionality zahrnují zejména: začlenění paralelního řešiče BDDCML do 
produkční verze, optimalizace a zobecnění modelu pro adsorpci, duální porozitu a 
rozpady, model vedení tepla a přechod na verzovací systém git. V roce 2013 bylo 
začleněno 540 sad změn.
\subsubsection{2014}
Drobné opravy a vylepšení, verze 1.8.1, testovací ulohy.

\subsection{Fyzikální modely}
\subsubsection{Nestacionární proudění}
\input darcy_flow

\subsubsection{Advekčně-difúzní model transportu rozpuštěných látek}
\label{sc:transport_model}
\input transport_model

\subsubsection{Model šíření tepla}
\label{sc:heat}
\input heat

\subsection{Zobecněný reakční člen}

\section{Numerické metody}
\subsection{Nespojitá Galerkinova metoda}
\input dg

\subsection{Transportní procesy na puklinách}
\label{sc:ad_on_fractures}
\input derivation_fractures

\subsection{"hrudková" smíšená-hybridní metoda}
\subsection{lineární řešič BDDCML}
Podpora paralelního řešiče BDDCML
Ve spolupráci s Jakubem Šístkem byly dokončeny práce na využití jeho paralelního 
řešiče implementujícího víceúrovňovou metodu BDDC. Práce zahrnovaly jak úpravy 
na straně Flow123d tak na straně knihovny. Aplikace metody BDDC na úlohy 
proudění s kombinacemi prvků různé dimenze je originální. Náročné bylo zejména 
zvládnutí velkých rozdílů ve vodivostech na rozhraních sub-struktur jednotlivých 
procesorů. Velké rozdíly se mohou objevit, pokud je rozhraní mezi 2D a 3D 
elementem. Pro zvládnutí této heterogenity ve vodivosti bylo navrženy a 
otestovány tři metody vážení tlaků na rozhraních. Uvažujme bod X na rozhraní 
sub-struktur hodnota tlaku v tomto bodě je rovna váženému průměru tlaků na 
jednotlivých sub-strukturách,. Standardní volba vah není vhodná pro heterogenní 
problémy. Pokud jsou materiálové parametry (v našem případě vodivost) výrazně 
rozdílné na jednotlových sub-strukturách, používá se škálování: . To ovšem 
předpokládá konstantní materiálové charakteristiky na jednotlivých 
sub-strukturách v našem případě, kdeje dimenze a je tenzor hydraulické vodivosti 
na elementu sub-struktury přiléhajícímu k X. Kombinace 2D a 3D elementů však 
může vést na výrazné oscilace podél rozhraní, pokud se hodnoty výrazně mění 
podél rozhraní. Proto jsme navrhli upravené škálování , kde používáme přímo 
hodnoty z asemblované matice, je diagonální hodnota z matice komunikace mezi 
dimenzemi. Ta je nenulová pouze v případě, že rozhraní odděluje elementy různé 
dimenze. Hodnota je diagonální hodnota z lokální matice elementu přiléhajícímu k 
rozhraní, chová se podobně jako , ale zahrnuje i vliv geometrie. Tabulka 2 
demonstuje porovnání jednotlivých metod vážení, aritmetické vážení dává špatné 
výsledky i pro malý počet procesorů a někdy naprosto selhává (N=128, 1024), 
-škálování dává většinou uspokojivé výsledky, ale selhává ve stejných případech 
jako aritmetické vážení. Je pravděpodobné, že jde o ty případy, kdy rozhraní 
sub-struktur leží mezi dimenzemi. Toto dělení je prováděno softwarem METIS a 
výskyt těchto patologických případů lze sice vhodným nastavením snížit, ale ne 
zcela vyloučit a to zejména pro větší počet sub-struktur. Poslední navržené 
škálování  však dobře funguje i s problemetickým rozdělením. To demonstruje 
poslední sloupeček tabulky, kde
počet iterací ani číslo podmíněnosti příliš neroste s počtem sub-struktur.

\begin{table}[ptbh]
\begin{center}
\begin{tabular}
[c]{|cc|ccc|cc|cc|cc|}\hline
\multirow{2}{*}{$N$} & \multirow{2}{*}{$n/N$} &
\multirow{2}{*}{$n_{\Gamma}$} & \multirow{2}{*}{$n_f$} &
\multirow{2}{*}{$n_c$} & \multicolumn{2}{c|}{arithmetic avg.} &
\multicolumn{2}{c|}{mod. $\rho$-scal.} & \multicolumn{2}{c|}{diagonal scal.}\\
&  &  &  &  & its. & cond. & its. & cond. & its. & cond.\\\hline
32 & 245k & 20k & 106 & 322 & 637 & 9811.7 & 110 & 1467.8 & 112 & 1514.1\\
64 & 123k & 28k & 192 & 597 & 618 & 10254.1 & 62 & 115.1 & 63 & 117.7\\
128 & 61k & 45k & 413 & 1293 & 2834 & 1.0e+11 & 206 & 401641.4 & 75 & 194.4\\
256 & 31k & 72k & 902 & 2791 & 799 & 11172.9 & 117 & 512.9 & 119 & 526.7\\
512 & 15k & 110k & 2009 & 6347 & 883 & 15449.6 & 136 & 1160.1 & 137 & 1143.4\\
1024 & 8k & 155k & 4575 & 14725 & n/a & 2.5e+10 & 504 & 99023.6 & 173 &
897.0\\\hline
\end{tabular}
\end{center}
\caption{\label{tab:tunnel_averaging}
Vliv druhu vážení na počet iterací a odhad podmíněnosti matice.
Comparison of 
different averaging techniques for the
\emph{Bed\v{r}ichov tunnel} containing 2D and 3D elements, size of the global
problem is $n$ = 7.8M unknowns.}
\end{table}

Ve druhé polovině roku 2013 byl řešič využívající knihovnu BDDCML začleněn do 
hlavní produkční větve a součástí verze 1.8.0. S využitím knihovny BDDCML bylo 
dosaženo velmi dobré silné škálovatelnosti při řešení velkých reálných úloh 
(miliony elementů) při využití až tisíce výpočetních jader, viz Obrázek 2. 
Výsledky byly shrnuty v článku \cite{SistekBDDC} zaslaného k recenzi. 

\section{Uživatelské rozhraní}
\subsection{Vstupní sooubor s hierarchickým formátem}
\subsection{Zadávání časoprostorových fyzikálních polí}
\subsection{Systém chybových hlášení}
\subsection{Výstupní rozhraní}

\section{Kvalita kódu}
\subsection{Správa verzí}
\subsection{Systém testů}
\subsection{Struktura programu}



\section{Vývoj za roky 2011--2014}

\begin{thebibliography}{99}

\bibitem{ern2010guaranteed}
A. Ern, A.F. Stephansen, M. Vohral{\'\i}k.
Guaranteed and robust discontinuous Galerkin a posteriori error estimates for convection--diffusion--reaction problems,
\emph{Journal of computational and applied mathematics}, 234(1):114--130, 2010.


\bibitem{ern_stephansen_zunino}
A. Ern, A.F. Stephansen, P. Zunino.
A discontinuous {G}alerkin method with weighted averages for advection--diffusion equations with locally small and anisotropic diffusivity,
\emph{IMA Journal of Numerical Analysis}, 29(2):235--256, 2009.


\bibitem{martin_modeling_2005}
V. Martin, J. Jaffr{\'e}, J.E. Roberts.
Modeling Fractures and Barriers as Interfaces for Flow in Porous Media,
\emph{{SIAM} Journal on Scientific Computing}, 26(5):1667--1691, 2005.


\bibitem{SistekBDDC}
J. Šístek, J. Březina, B. Sousedík : BDDC for Mixed-Hybrid 
Formulation of Flow in Porous Media with Combined Mesh Dimensions, Numer. Linear 
Algebra Appl. (submitted)
\end{thebibliography}




\end{document}