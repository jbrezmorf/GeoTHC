\documentclass[11pt]{report}

\usepackage{helvet}
\renewcommand{\familydefault}{\sfdefault}
\renewcommand{\rmdefault}{\sfdefault}
%\usepackage{sfmath}
%\usepackage{sansmath}

\usepackage[utf8]{inputenc}
\usepackage[czech]{babel}
\usepackage{amsfonts,amsmath}
\usepackage{etoolbox}
\usepackage{graphicx}
\usepackage{multirow}
\usepackage{titlesec}
\setcounter{secnumdepth}{3}
\usepackage[total={8.27in, 11.60in}, left=0.82in, right=0.82in,%
top=1.49in, bottom=1.49in]{geometry}
\usepackage{float}

\usepackage{fancyhdr}
\pagestyle{fancy}
\lhead{
    \begin{picture}(0,0)
        \put(-60,0){\includegraphics{TACR_logo.png}}
    \end{picture}
    }
\rhead{}    
\cfoot{}
\rfoot{\thepage}
\renewcommand{\headrulewidth}{0pt}

\usepackage{tikz}

% macro for units.
\def\UNIT#1#2{\ifstrempty{#2}{}{%
\ifstrequal{#2}{1}{\mathrm{#1}}{\mathrm{#1}^{#2}}%
}}
\def\units#1#2#3{\ifstrempty{#1#2#3}{$[-]$}{$[ \UNIT{kg}{#1}\UNIT{m}{#2}\UNIT{s}{#3} ]$}} %with brackets
\def\unitss#1#2#3{\ifstrempty{#1#2#3}{$-$}{$ \UNIT{kg}{#1}\UNIT{m}{#2}\UNIT{s}{#3} $}}    %without brackets

%macro for hyperlinks (dummy)
\def\hyperA#1#2{#2}


\begin{document}


%\ULCornerWallPaper{1}{\includegraphics{TACR_logo.png}}
%\LLCornerWallPaper{1}{bar}
%\lipsum[1-3]

\title{Závěrečná zpráva projektu GeoTHC}
\maketitle
\chapter{A}
\chapter{B}
\chapter{C}

\pagebreak
\setcounter{page}{10}
\section{Vývoj numerického software Flow123d}
Program Flow123d je softwarový nástroj pro simulaci termálních, hydrologických 
a chemických (THC) procesů v rozpukaném porézním prostředí. Podporovné 
fyzikální modely zahrnují: Darcyovské proudění, transport látek, jejich reakce, 
fyzikální a chemické interakce s horninou a vedení tepla. Program je schopen 
popsat explicitně procesy v 3D médiu, 2D puklinách, a 1D preferenčních cestách a 
komunikaci mezi těmito doménami různých dimenzí. Tento přístup umožňuje výpočty 
v regionálním měřítku se zahrnutím vlivu jemných struktur s výrazně odlišnými 
materiálovámi parametry, např. geologických zlomů. Zejména je vhodný pro  
modelování transportních procesů v žulových masivech s komplexních geologickou 
strukturou.  

\subsection{Přehled vývoje v průběhu projektu}

\subsubsection{Počáteční stav}
Prvotní verze programu vznikla v rámci dizertační práce 
Otto Severýna okolo roku 2004. Program umožňoval výpočet stacionárního 
%\hyphenation{ko-neč-ných}
Darcyovského proudění pomocí metody smíšených hybridních konečných prvků 
nultého řádu. Originalita nespočívala v komplexnosti řešené rovnice (jedná o 
lineární eliptickou rovnici), ale v komplexnosti výpočetní oblasti. Program 
umožňuje modelovat 3D kontinuum obsahující relativně tenké 2D pukliny a 1D 
kanály pomocí 2D a 1D konečných prvků a řeší tak sdruženou úlohu jedné rovnice 
proudění na výpočetních oblastech různé dimenze. Později byl program významně 
rozšířen.

Ke konci roku 2010 umožňoval software výpočet stacionárního proudění a 
navazující výpočet transportu. 

Lineární systém algebraických rovnic vyplývající 
ze smíšené-hybridní diskretizace problému proudění byl řešen paralelně pomocí 
knihovny PETSc. Byla implementována paralelní redukce soustavy pomocí 
Schurových doplňků a redukovaný systém s pozitivně definitní maticí byl řešen 
metodou sdružených gradientů s možností široké škály předpodmiňovačů dostupných 
přes rozhraní knihovny PETSc. Transportní rovnice (pouze konvekce bez difúze) 
zahrnovala koncept duální porozity (mobilní a immobilní póry) a sorpci látky 
do horniny. Bylo možno řešit transport více látek najednou. Transportní rovnice 
byla řešena explicitní Eulerovou metodou a metodou konečných objemů s upwindem.  
Výpočet jednoho časového kroku byl realizován paralelně pomocí maticového 
násobení knihovny PETSc. 

Vstupní data programu byla zadávána v několika 
souborech s rozdílným formátem. Pro jejich přípravu bylo třeba použít 
další podpůrné softwarové nástroje což značně komplikovalo jakoukoliv 
jejich změnu. Výstup výsledných skalárních a vektorových 
polí byl realizován pouze do formátu programu GMSH, který není podporován jiným 
vizualizačním software. K dispozici byla elementární dokumentace vstupních 
souborů. Software měl již vlastni SVN repozitář pro správu verzí a webové 
stránky projektu. Bylo vytvořeno několik testů pro ověření základní 
funkcionality. 


\subsubsection{2011 -- verze 1.6.5}
Byly rozpracovány třídy pro řešení rovnice konvekce-difúze pomocí nespojité 
Galerkinovy metody s implicitní časovou diskretizací. Byl implementován model 
pro rozpady a jednosložkové reakce. Byla vytvořena třída pro obecné sekvenciální 
propojení rovnic (proudění ustálené i neustálené a transportu). Do modelu 
transportu byly implementovány dva typy objemových zdrojů koncentrací 
transportovaných veličin. Byla také přidána možnost zadávat časově závislé 
okrajové podmínky transportu.
Byla implementována numerická metoda „lumped mixed-hybrid“ pro neustálené 
proudění, která, na rozdíl od klasické smíšené-hybridní metody, splňuje při 
řešení evolučních úloh diskrétní princip maxima. Porušení principu maxima přitom 
může vést na nefyzikální překmity a oscilace. Při iteračním řešení nelineárních 
či sdružených úloh pak může vést k problémům s konvergencí.
Byly testovány dvě metody propojení rovnic proudění na nekompatibilních 2D a 1D 
sítích při spojitém tlaku. Pro obě byla ověřena konvergence k odvozenému 
analytickému řešení.
Použití metody BDDC bylo úspěšně testováno na úlohách stacionárního proudění na 
sítích s prvky více dimenzí. Její hlavní výhodou je velmi dobrá škálovatelnost a 
tedy možnost řešení velmi rozsáhlých úloh. Metoda se zdá výhodná i kvůli tomu, 
že není nutná samostatná konstrukce Schurových doplňků ke zmenšení velikosti 
systému, neboť proměnné eliminované při použití Schurových doplňků jsou 
samostatně eliminovány na jednotlivých subdoménách.
Bylo vytvořeno jednotné výstupní rozhraní pro výstup skalárních a vektorových 
polí do formátu GMSH nebo formátů VTK. Nové rozhraní je nyní použito pro výstup 
všech datových polí. Dále bylo navrženo a částečně implementováno vstupní 
rozhraní a byla vytvořena podrobná specifikace nových vstupních souborů. 
Byla rozšířena a zkvalitněna sada testovacích úloh a vytvořen sytém pro 
automatické spouštění testů a porovnávání vůči referenčním výsledkům. Testovací 
sada je automaticky spouštěna pro každou změnu zdrojových kódů a výsledky jsou 
publikovány na webu projektu. 

\subsubsection{2012 -- verze 1.7.0}
Byla dokončena implementace modelu pro advekci a difúzi s zahrnutím 
hydrodynamické disperze. Model používá nespojitou Galerkinovu metodu pro 
diskretizaci v prostoru a implicitní Eulerovu metodu pro časovou integraci.  
Pole koncentrací je diskretizováno pomocí po částech lineárních funkcí na 
jednotlivých elementech (čtyřstěnech, trojúhelnících, či úsečkách), spojitost 
řešení je vynucena penalizačním členem ve slabé formulaci řešené rovnice. Model 
byl odladěn na několika testovacích úlohách, je podporováno parallelní 
sestavování matic i a parallelní řešení soustav na jednotlivých časových 
úrovních.
Bylo optimalizováno a zjednodušeno uložení výpočetní sítě a nástroj ngh pro 
hledání sousedností mezi dimenzemi byl začleněn přímo do Flow123d. Vyhledávání 
kompatibliních sousedností probíhá přímo na načtené výpočetní síti což je 
rychlejší a zmenšuje paměťové nároky. 
Dále bylo dokončeno a aplikováno nové vstupní rozhraní. Veškeré vstupy programu 
jsou nyní čteny přes toto rozhraní, které umožňuje automatické vytvoření 
referenční dokumentace hlavního vstupního souboru ve formátu JSON.
Byly navrhnuty a implementovány třídy pro zadávání časo-prostorových skalárních, 
vektorových či tenzorových polí. Většinu parametrů v modelech lze nyní zadávat 
jednotným způsobem. Pro parametr zadávaný pomocí „Field“ rozhraní, lze pro každý 
region sítě předepsat prostorovou závislost pomocí jednoho ze šesti 
elementárních funkcí. Elementární funkce FieldConstant poskytuje prostorově 
konstantní hodnoty, FieldFormula umožňuje zadat funkci pomocí vzorce 
obsahujícího parametry t,x,y,z, který je přeložen až při běhu programu, 
FieldPython umožňuje výpočet hodnot pomocí programu v jazyce Python, 
FieldElementwise slouží k zadání po částech konstantní diskrétní funkce na 
stejné síti jaká se použije k diskretizaci rovnice jíž je funkce parametrem, a 
konečně FieldInterpolated umožňuje interpolovat hodnotu z po částech konstantní 
diskrétní funkce na jiné síti. 
Poslední zmíněná elementární funkce umožňuje interpolace prostorových dat jedné 
sítě na data okrajových podmínek na jiné síti. Pro efektivní vyhledávání 3D 
elementů protínajících 2D a 1D prvky hranice byla implementována metoda  
„Bounding interval hierarchy“. Též bylo nutné implementovat funkce pro výpočet 
průniku s nalezenými 3D elementy.
 Během roku 2012 bylo začleněno přes 500 sad změn. 
\subsubsection{2013 -- verze 1.8.0}
Verze 1.7.0 z předchozího roku přinesla dvě velké změny: nový model 
advekce-difúze a nové vtupní rozhraní. Obě přinesly rozšíření možností 
simulátoru, ale zároveň mohlo dojít ke zhoršení výkonu. V roce 2013 bylo 
provedeno podrobné porovnání výsledků a výkonu oproti verzi 1.6.7 na reálných 
úlohách, byly opraveny drobné chyby a vyřešeny podstatné výkonnostní problémy.  
Nové funkcionality zahrnují zejména: začlenění paralelního řešiče BDDCML do 
produkční verze, optimalizace a zobecnění modelu pro adsorpci, duální porozitu a 
rozpady, model vedení tepla a přechod na verzovací systém git. V roce 2013 bylo 
začleněno 540 sad změn.
\subsubsection{2014}
Drobné opravy a vylepšení, verze 1.8.1, testovací ulohy.

\subsection{Fyzikální modely}
\subsubsection{Nestacionární proudění}

\subsubsection{Advekčně-difúzní model transportu rozpuštěných látek}
\label{sc:transport_model}
\input transport_model

\subsubsection{Model šíření tepla}
\label{sc:heat}
\input heat

\subsection{Zobecněný reakční člen}
Verze 1.6.7 umožňovala zahrnutí rovnovážné sorpce a duální porozity v modelu 
explicitního transportu. Ve verzi 1.7.0 byla tato funkcionalita zachována, ale 
parametry obou modelů byly zadávány pomocí tříd pro časo-prostorová pole což 
vedlo k dramatickému zpomalení. Byly implementovány třídy pro výpočet rozpadů a 
jednoduchých reakcí, ale pouze v kapalné fázi, tj. bez uvažování sorpce či 
duální porozity. Sorpce, duální porozita i jednoduché reakce byly implementovány 
pouze na explicitní transport pomocí metody štěpení operátoru. 

Ve verzi 1.8.0 je také použita metoda štěpení operátoru, ale je možné kombinovat 
jednotlivé lokální modely. V jednom časovém kroku se nejprve spočítá transport 
látky bez dalších vlivů a následně jsou v každém elementu spočteny
modely reakčního členu: nerovnovážná výměna s duálními póry, rozpady a 
jednoduché reakce v primárních i duálních pórech v rozpuštěné i sorbované fázi a 
nakonec je spočtena rovnovážná sorpce v primárních i duálních pórech. Tyto 
modely je možno kombinovat jak je znázorněno na Obrázku 
\ref{fig:reaction_term}. Uživatel tak může volit jak komplexní děje chce 
reakčním členem popsat. Může to být pouhá reakce typu "Jaderný rozpad" nebo 
komplexní schéma zahrnující duální porozitu, jiný druh sorpce pro mobilní a 
imobilní póry a čtyři druhy reakcí v roztoku/hornině v mobilních/imobilních 
pórech.

\begin{figure}[h]
 \centering
 \includegraphics[scale=0.4]{./reaction_term.pdf}
 % reaction_term.pdf: 842x595 pixel, 72dpi, 29.70x20.99 cm, bb=0 0 842 595
 \caption{Struktura reakčního členu. Dělený box má v horní části fyzikální 
kontext a v dolní části výčet modelů, které lze v daném kontextu použít.}
 \label{fig:reaction_term}
\end{figure}


Technicky umožňujeme použití 
metody štěpení operátoru pro explicitní i implicitní transport, nicméně v 
případě implicitního transportu je třeba volit dostatečně krátký časový krok.

\subsubsection{Duální porozita}
Model umožňuje popsat retenční vlastnosti slepých pórů a puklin, které se 
efektivně projevují při simulacích na velkém měřítku. Porézní médium je 
rozděleno na mobilní póry, mobilní porozita $\theta_m$, a imobilní póry, 
imobilní porozita $\theta_i$. Mezi těmito póry nedochází k proudění vody, ale 
dochází k výměně látky difúzí. Tato nerovnovážná výměna je řízena jednoduchou 
lineární soustavou obyčejných diferenciálních rovnic:
\begin{align}
    \vartheta_m \partial_t c_m &= D_{dp} ( c_i - c_m), 
\label{eqn:dual_porosity_ode1}\\
    \vartheta_i \partial_t c_i &= D_{dp} ( c_m - c_i), 
\label{eqn:dual_porosity_ode2}
\end{align}
kde $c_m$ je koncentrace látky v mobilní zóně, $c_i$ je koncentrace látky v 
imobilní zóně a $D_{dp}$ je koeficient difúze mezi zónami.


\subsubsection{Sorpce}
Implementace rovnovážných sorpcí byla kompletně předělána. Byla zachována 
možnost zadávat všechny parametry pomocí časo-prostorových polí, nicméně pro 
případ parametrů konstantních na jednotlivých regionech je implementován výpočet 
pomocí předpočítaných interpolací, který umožňuje efektivní výpočet jak pro 
lineární tak nelineární sorpční izotermy. Výpočet rovnovážné sorpce pro jednu 
látku spočívá v řešení soustavy rovnic sestávající z bilance hmoty,
\begin{equation}
\label{eq:mass_balance_sorption}
\th \varrho_l c_l + (1-\th) \varrho_s M_s c_s = c_T = const.
\end{equation}
a z empirického vztahu nazývaného sorpční izoterma:
\[
    c_s=f(c_l).
\]
V těchto rovnicích jsou neznámé hmotnostní koncentrace látky v roztoku $c_l$ a 
molární koncentrace látky v hornině $c_s$, další veličiny jsou hustota 
rozpouštědla (vody) $\varrho_l$, hustota horniny $\varrho_s$, molární hmotnost 
látky $M_s$ a celková koncentrace $c_T$. Výpočet probíhá tak, že po transportu 
látky je porušena sorpční rovnováha, z rovnice \eqref{eq:mass_balance_sorption} 
se vypočte celková koncentrace (celková hustota hmotnosti látky) a pak se 
naleznou nové rovnovážné hodnoty $c_s$, $c_l$.

Momentálně jsou implementovány lineární, Langmuierova a Freundlichova izoterma. 
Obvykle jsou parametry rovnice závislé pouze na látce a regionu a pro 
jednotlivé elementy jednoho regionu je třeba spočítat rovnovážné koncentrace pro 
různé hodnoty celkové koncentrace $c_T$. V tom případě uvažujeme graf izotermy 
v otočené soustavě (viz. Obr. 3).

Hodnoty veličiny
\[
    Y=-\mu_s c_l + \mu_l c_s =  -M_s(1-\theta) \varrho_s c_l + \theta\rho_l 
\]

v závislosti na $c_T$ jsou tabelovány a mezihodnoty dopočítávány lineární 
interpolací. Rovnovážné koncentrace pak dostaneme zpětným otočením:
\[
    c_l = \frac{\mu_l c_T + \mu_s Y}{\mu_s^2+\mu_l^2},\quad c_s = 
\frac{-\mu_s c_T - \mu_l Y}{\mu_s^2 + \mu_l^2}.
\]

Tímto způsobem jsme schopni počítat i nelineární sorpce stejně efektivně jako 
lineární. Tabulka \ref{tab:isoterm_timing} shrnuje výsledky benchmarkových 
testů. Porovnáváme čas výpočtu sorpcí (v sekundách) pro tři různé izotermy a 
tři 
různé verze kódu. V prvním sloupci jsou časy původní implementace z verze 1.6.7. 
Ve druhém sloupci jsou výsledky pro implementaci využívající interpolace při 
prostorově konstantních parametrech izoterm. Dosáhli jsme značného zrychlení 
pro 
nelineární izotermy. Ve třetím sloupečku jsou časy při použití  plně prostorově 
závislých parametrů, kde je nelineární rovnice řešena pro každý element, látku 
a časový krok. Zde je ještě prostor pro optimalizace. Přibližně $11$s trvá 
výpočet prostorově závislých parametrů nicméně i po odečtení tohoto konstantního 
faktoru jsou časy výrazně horší než pro verzi 1.6.7. Tuto variantu však 
neplánujeme používat pro rozsáhlé oblasti a hoší výkon proto nepředstavuje 
praktické omezení. Další optimalizace by bylo možné dosáhnout použitím Newtonovy 
metody pro řešení nelineárních rovnic, jako tomu bylo ve verzi 1.6.7. Zde 
používáme metodu pomalejší, ale stabilnější a umožňující snadné přidávání nových 
izoterm.

\renewcommand{\arraystretch}{1.5}
\begin{table}
\begin{center}
\begin{tabular}{|l||c|c|c|}
\hline
izoterma & verze 1.6.7 & v. 1.8.0 (interpolace) & v. 1.8.0 (přímý výpočet) \\
\hline
Lineární & 1.58        & 1.48                   & 28\\
Langmuirova & 5.87     & 1.44                   & 36\\
Freundlichova& 19.21   & 1.50                   & 44\\
\hline
\end{tabular}
\end{center}
\caption{\label{tab:isoterm_timing}
Doba výpočtu sorpcí v sekundách pro různé izotermy a tři různé verze 
kódu: původní, s použitím interpolací a při plně prostorově závislých 
parametrech.}
\end{table}

\section{Numerické metody}
\subsection{Nespojitá Galerkinova metoda}
\input dg

\subsection{Transportní procesy na puklinách}
\label{sc:ad_on_fractures}
\input derivation_fractures

\subsection{Diagonalizovaná smíšená-hybridní metoda}


\subsection{Lineární řešič BDDCML}
Ve spolupráci s Jakubem Šístkem byly dokončeny práce na využití jeho 
paralelního řešiče implementujícího víceúrovňovou metodu BDDC. Práce zahrnovaly 
jak úpravy na straně Flow123d tak na straně knihovny. Aplikace metody BDDC na 
úlohy proudění s kombinacemi prvků různé dimenze je originální. Náročné bylo 
zejména zvládnutí velkých rozdílů ve vodivostech na rozhraních sub-struktur 
jednotlivých procesorů. Velké rozdíly se mohou objevit, pokud je rozhraní mezi 
prvky různé dimenze, kde může docházet k velkým skokům vodivosti na hranici 
rozhraní. Pro zvládnutí této heterogenity ve vodivosti bylo navrženy a 
otestovány tři metody vážení tlaků na rozhraních. Uvažujme bod $X$ na rozhraní 
sub-struktur $s=1,\dots,n$. Hodnota tlaku $p$ v tomto bodě je rovna váženému 
průměru tlaků $p_s$ na jednotlivých sub-strukturách, 
\[
    p = \sum_{s=1}^n p_s. 
\]

Standardní volba vah $w_s=1/n$ (aritmetický průměr) není vhodná pro heterogenní 
problémy. Pokud jsou materiálové parametry (v našem případě vodivost a 
rozevření puklin) výrazně rozdílné na jednotlivých sub-strukturách, používá se 
$\rho$-škálování:
\[
    w_s=\frac{\rho_s}{\sum_{s=1}^n \rho_s}.
\]
To ovšem předpokládá konstantní materiálové charakteristiky na jednotlivých 
sub-strukturách v našem případě $\rho_s=\frac{d}{\text{tr}(\tn K^{-1})}$, 
kde $d$ dimenze elementu a $\tn K$ je tenzor 
hydraulické vodivosti na elementu sub-struktury přiléhající k $X$. Kombinace 2D 
a 3D elementů však může vést k oscilacím, pokud se 
hodnoty $\rho_s$ výrazně mění podél rozhraní. Proto jsme navrhli upravené 
{\emph diagonální škálování}
\[
    \rho_s=C^s_{jj} + \frac{1}{A^s_{kk}},
\]
kde používáme přímo hodnoty z 
asemblované matice, $C^s_{jj}$ je diagonální hodnota z matice komunikace mezi 
dimenzemi. Ta je nenulová pouze v případě, že rozhraní odděluje elementy různé 
dimenze. Hodnota $A^s_{kk}$ je diagonální prvek z lokální matice elementu 
přiléhajícímu k rozhraní, chová se podobně jako $\tn K^{-1}$, ale zahrnuje i 
vliv geometrie. 




Tabulka \ref{tab:tunnel_averaging} demonstruje porovnání 
jednotlivých metod vážení, aritmetické vážení dává špatné výsledky i pro malý 
počet procesorů a někdy naprosto selhává (N=128, 1024), $\rho$-škálování dává 
většinou uspokojivé výsledky, ale selhává ve stejných případech jako aritmetické 
vážení. Jde o ty případy, kdy rozhraní sub-struktur leží 
mezi dimenzemi. Toto dělení je prováděno softwarem METIS a výskyt těchto 
patologických případů lze sice vhodným nastavením snížit, ale ne zcela vyloučit 
a to zejména pro větší počet sub-struktur. Poslední navržené škálování  však 
dobře funguje i s problematickým rozdělením. To demonstruje poslední sloupeček 
tabulky, kde
počet iterací ani číslo podmíněnosti příliš neroste s počtem sub-struktur.

\begin{table}[t]
\begin{center}
\begin{tabular}
[c]{|cc|ccc|cc|cc|cc|}\hline
\multirow{2}{*}{$N$} & \multirow{2}{*}{$n/N$} &
\multirow{2}{*}{$n_{\Gamma}$} & \multirow{2}{*}{$n_f$} &
\multirow{2}{*}{$n_c$} & \multicolumn{2}{c|}{aritmetický průměr} 
&
\multicolumn{2}{c|}{$\rho$-škálování} & \multicolumn{2}{c|}{diagonální 
škálování}\\
&  &  &  &  & its. & cond. & its. & cond. & its. & cond.\\\hline
32 & 245k & 20k & 106 & 322 & 637 & 9811.7 & 110 & 1467.8 & 112 & 1514.1\\
64 & 123k & 28k & 192 & 597 & 618 & 10254.1 & 62 & 115.1 & 63 & 117.7\\
128 & 61k & 45k & 413 & 1293 & 2834 & 1.0e+11 & 206 & 401641.4 & 75 & 194.4\\
256 & 31k & 72k & 902 & 2791 & 799 & 11172.9 & 117 & 512.9 & 119 & 526.7\\
512 & 15k & 110k & 2009 & 6347 & 883 & 15449.6 & 136 & 1160.1 & 137 & 1143.4\\
1024 & 8k & 155k & 4575 & 14725 & n/a & 2.5e+10 & 504 & 99023.6 & 173 &
897.0\\\hline
\end{tabular}
\end{center}
\caption{\label{tab:tunnel_averaging}
Vliv druhu vážení na počet iterací a odhad podmíněnosti matice.
\emph{tunel Bedřichov}, 2D a 3D elementy, 7.8 miliónů neznámých}
\end{table}

\begin{figure}[h]
\begin{center}
\includegraphics[width=0.48\textwidth]{timing_melechov_large} 
\includegraphics[width=0.48\textwidth]{speedup_melechov_large}
\end{center}
\caption{\label{fig:timing_Melechov_large}
Strong scaling test for the problem of the \emph{Melechov locality}
containing 2D and 3D elements and 15M unknowns, computational time (left) and
speed-up (right) separately for set-up and PCG phases, and their sum (solve).}
\end{figure}

Ve druhé polovině roku 2013 byl řešič využívající knihovnu BDDCML začleněn do 
hlavní produkční větve a součástí verze 1.8.0. S využitím knihovny BDDCML bylo 
dosaženo velmi dobré silné škálovatelnosti při řešení velkých reálných úloh 
(miliony elementů) při využití až tisíce výpočetních jader, viz Obrázek~2. 
Výsledky byly shrnuty v článku \cite{SistekBDDC} zaslaného k recenzi.




\section{Uživatelské rozhraní}
\subsection{Vstupní sooubor s hierarchickým formátem}
Až do verze 1.6.7 byl hlavní vstupní soubor ve formátu \verb'INI', 
ten obsahoval odkazy na další soubory se vstupními daty. Formát těchto souborů 
nebyl nijak sjednocen a pro každý soubor musela existovat samostatná čtecí 
funkce. Dokumentace těchto souborů byla neúplná.

V rámci projektu bylo navrženo nové vstupní rozhraní s následujícími 
vlastnostmi.
\begin{itemize}
\item Rozhraní umožňuje deklarovat hierarchickou strukturu vstupů 
přímo ve zdrojovém kódu a to nezávisle na konkrétním formátu vstupního souboru.
%
\item V rámci deklarace je možné vstupy dokumentovat a tuto dokumentaci je 
možné vypsat uživateli nebo vygenerovat technickou dokumentaci pomocí 
typografického systému \LaTeX.
%
\item Rozhraní implementuje čtení vstupních dat z 
vhodných hierarchických vstupních formátu (aktuálně podporován formát JSON s 
drobnými rozšířeními). Během čtení je prováděna kontrola vstupních dat vůči 
deklarované struktuře.
%
\item Rozhraní poskytuje jednotný přístup k načteným datům na straně programu. 
\end{itemize}

V průběhu roku 2012 bylo toto vstupní rozhraní implementováno. Struktura 
vstupních dat je popsána pomocí tříd (ve jmenném prostoru \verb'Inut::Type') 
pro základní typy dat: \verb'String', \verb'Bool', \verb'Integer', 
\verb'Double', \verb'FileName' a \verb'Selection' (obdoba typu enum z jazyka 
C). Objekty třídy \verb'Array' definují složený datový typ, seznam dat 
stejného typu, ke kterým se přistupuje pomocí pořadí. Objekty třídy 
\verb'Record' definují složený datový typ, kde se k jednotlivým datů přistupuje 
přes pojmenované klíče, přičemž tato data mohou být různého typu. Objekty třídy 
\verb'AbstractRecord' umožňují jednoduchou dědičnost a zejména polymorfismus. 
Typ \verb'Record' může být definován jako potomek nějakého typu 
\verb'AbstractRecord'. Polymorfismus dovoluje definovat pole 
\verb'Array' sestávající z dat nějakého \verb'AbstractRecord' typu $X$.
Na vstupu pak lze do pole ukládat data libovolných 
\verb'Record' typu $Y$, pokud $Y$ je potomkem $X$. Vstup pro typy 
\verb'AbstractRecord' musí obsahovat speciální klíč \verb'TYPE', který 
specifikuje jméno \verb'Record' typu (potomka), který se na vstupu vyskytuje. 
V programu je tak možno vytvořit instanci příslušné třídy.
Takto je možno deklarovat velice obecnou hierarchickou strukturu vstupních dat 
se zahrnutím dokumentace a implicitních hodnot.

Byly implementovány třídy pro výstup deklarované hierarchie v několika 
formátech. Zadáním vhodných argumentů programu Flow123d na příkazové řádce
lze vypsat hierarchii vstupu v několika formátech:
\begin{itemize}
 \item Textový formát. (parametr \verb'--full_doc') Vypíše úplný popis 
hierarchie v textovém formátu či
 \item LaTeX formát. (parametr \verb'--latex_doc') Vygeneruje úplný popis 
hierarchie v LaTeX formátu. Spolu se sadou speciálních maker je možné 
vygenerování PDF s technickou dokumentací a její propojení s ručně psanou částí 
pomocí hyperlinků. 
 \item JSON strojově čitelný formát. (parametr \verb'--JSON_machine') Vygeneruje 
úplný popis hierarchie ve formátu JSON, který je vhodný pro strojové 
zpracování. Do budoucna umožní například tvorbu grafického nástroje pro 
přípravu vstupních dat.
\end{itemize}


Dále byla implementována čtečka datového formátu JSON. Pro lepší srozumitelnost 
vstupních souborů byla zahrnuta možnost vkládání komentářů (není součást 
standardu JSON, ale součást jazyka JavaScript, jehož je JSON součástí). 
Pro lepší čitelnost vstupních souborů dovoluje čtečka vynechání uvozovek u 
jmen klíčů a použití rovnítka pro přiřazení hodnoty (místo dvojtečky).
Čtečka provádí kontrolu vstupu oproti jeho deklaraci a jednotným způsobem hlásí 
chyby na vstupu včetně jejich logické pozice ve vstupním souboru. Načtená data 
jsou ukládána do jednoduché stromové struktury, odkud jsou přístupná 
prostřednictvím přístupových tříd \verb'Record', \verb'AbstractRecord' a 
\verb'Array' (ze jmenného prostoru \verb'Input'), které umožňují čtení pomocí 
klíče (třída \verb'Record') respektive pomocí iterátoru (třída \verb'Array').

Vstupní rozhraní plně nahradilo dřívější hlavní \verb'INI' soubor a umožnilo 
lépe strukturovat a dále rozšiřovat strukturu vstupních dat. Pro snadnější 
přechod na nový formát vstupních dat byl vytvořen jednoduchý konvertor 
\verb'INI' souboru do formátu JSON s příslušnou novou strukturou.  

\subsection{Zadávání časoprostorových fyzikálních polí}
S využitím nového vstupního rozhraní byla vytvořena hierarchie tříd (Field) pro 
jednotný vstup časoprostorových skalárních, vektorových či 
tenzorových polí. Tento přístup nahradil všechny další vstupní soubory 
s výjimkou souborů s výpočetní sítí. Další výhodou je možnost zadávat data 
nezávisle na konkrétní síti, ale pouze v  návaznosti na její geometrii danou 
soustavou regionů.

Naprostou většinu parametrů rovnic lze chápat jako funkce času a polohy ve 
výpočetní oblasti nebo její hranici (okrajové podmínky).  Třída 
\verb'Field', respektive šablona parametrizovaná typem 
závislé hodnoty (diskrétní, skalár, vektor, tenzor), reprezentuje 
takovéto funkce. Třída zejména implementuje  metodu pro výpočet 
závislé hodnoty pro daný čas a bod ve výpočetní oblasti.
Z důvodů efektivní implementace se metodě předává jako parametr i 
element, na kterém bod leží. Množina elementů tvořících jednu logickou 
oblast (např. jeden materiál) se nazývá {\emph region}. Třída \verb'Field' 
obsahuje tabulku, která každému regionu přiřazuje instanci třídy (respektive 
šablony) \verb'FieldBase'. Potomci této třídy implementují vlastní výpočet 
závislé hodnoty pro konkrétní region. Volbou potomka (pomocí klíče 
\verb'TYPE') může uživatel zvolit algoritmus použitý pro výpočet závislé 
hodnoty. V současné době jsou implementovány třídy:
\begin{itemize}
 \item {\tt FieldConstant} 
 --- zadání konstantní hodnoty na regionu.
 \item {\tt FieldFormula} 
 --- zaání funkce pomocí vzorce obsahujícího proměnné 
 $t$, $x$, $y$,$z$.
 \item {\tt FieldPython} 
 --- umožňuje výpočet hodnot pomocí funkce v jazyce Python.
 \item {\tt FieldElementwise} 
 --- diskrétní funkce po částech konstantní na elementech sítě. Hodnoty 
ve formátu GMSH dané ve zvláštním souboru. Vyžaduje data zadaná na stejné síti 
jako je síť výpočetní. 

 \item {\tt FieldInterpolated}
 --- diskrétní funkce po částech konstantní na elementech sítě. Hodnoty 
jsou interpolovány ze sítě a dat ve formátu GMSH dané ve zvláštním souboru.
\end{itemize}

Koncept {\emph Fields} byl natolik úspěšný, že byl dále rozšířen i pro 
předávání vypočtených fyzikálních polí do výstupního rozhraní a mezi 
rovnicemi.

{\bf Interpolace mezi sítěmi.}
Aktuálně je implementována interpolace po částech konstantních dat z 3D sítě na 
data konstantní na 2D a 1D elementech. Interpolovaná hodnota na elementu $X$ je 
vypočtena jako vážený průměr hodnot na elementech mající s $X$ neprázdný 
průnik. Váhy jsou dány velikostí průniku.
Pro efektivní výpočet je třeba k danému 
elementu $X$ cílové sítě najít seznam elementů zdrojové sítě, které mají s $X$ 
neprázdný průnik a to maximálně se složitostí $O(log N)$ vzhledem k velikosti 
zdrojové sítě. Toho je dosaženo vytvořením vyhledávacího stromu nad elementy 
zdrojové sítě, konkrétně je použita metoda \uv{Bounding interval hierarchy}
(BIH). 
Vyhledávací strom BIH pro zadaný element vytvoří obalový box a vrátí seznam 
elementů jejichž obalové boxy s ním mají neprázdný průnik. Pro každý takový 
element podezřelý z průniku, je třeba nalézt skutečný průnik se vstupním 
elementem. Toto je zatím implementováno jen pro dvojice 3D-2D a 3D-1D elementů. 
Rozpracovaný je výpočet průniků pro další kombinace dimenzí a algoritmy 
pro hledání všech průniků v lineárním čase.

\subsection{Systém chybových hlášení}
Pro snadné používání programu je důležité dostatečně podrobné 
reportování chyb. V případě chyby by měl uživatel dostat relevantní 
informace o příčinách jejího vzniku. 
Až do verze 1.6.7 byly uživatelské i programové chyby vypisovány přímo v místě 
detekce chyby, kde ovšem často nejsou k dispozici všechny potřebné informace. 
Při vývoji vstupního rozhraní byl pro reportování chyb použit systém výjimek, 
který umožňuje zachytit výjimku ve vyšší vrstvě a přidat do ní dodatečné 
informace. Mechanismus výjimek jazyka C++ zároveň zajistí zavolání všech 
destruktorů a kontrolované ukončení programu.
Nový systém výjimek byl dále použit i v dalších částech 
programu a byly do něj zapouzdřeny i původní funkce pro vypisování chybových 
zpráv. 

\subsection{Výstupní rozhraní}
Před započetím projektu umožňoval Flow123d výstup pouze několika veličin do 
formátu GMSH. Jedná se sice o otevřený datový formát s jednoduchou strukturou, 
ale k vizualizaci a postprocesingu dat je možné použít pouze program GMSH, 
který je však primárně určen k přípravě výpočetních sítí. V rámci projektu byla 
přidána podpora pro výstup do formátu VTK, který je podporován většinou 
vizualizačních programů. Dále bylo implementováno výstupní rozhraní, které 
umožňuje výstup libovolného pole \verb'Field'. Uživatel tak může vybrat pro 
výstup jak vstupní tak vypočtená pole, případně jejich částečně zpracované 
varianty. Výstup je podporován jak do GMSH tak do VTK formátů a to pomocí třech 
různých diskretizací: data konstantní na elementech, lineární funkce na 
elementech dané hodnotami v uzlech sítě, lineární funkce na elementech 
nespojité přes hranice elementů. První varianta je přirozená pro metodu 
konečných objemů, druhé pro spojitou Galerkinovu  metodu prvního řádu a 
třetí varianta je přirozená pro nespojitou Galerkinovu metodu prvního 
řádu. Všechny varianty umožňují výstup skalárních, vektorových, i tenzorových 
dat.

\section{Kvalita kódu}

Vzhledem ke stále intenzivnějšímu vývoji a rozšiřování vývojového týmu jsme se 
rozhodli přejít na nový systém pro správu verzí (git) a nový hosting centrálního 
repozitáře (github). Tyto nástroje velmi zefektivňují týmovou spolupráci a 
organizaci vývoje. Prezentace projektu na serveru github navíc přispívá k jeho 
zviditelnění a umožňuje jednodušší spolupráci s externími vývojáři. Se změnou 
verzovacího nástroje jsme museli změnit software pro průběžnou integraci (CI) a 
testování. V současnosti používáme volně dostupný software Jenkins. Byl také 
zprovozněn nový testovací a sestavovací server jak pro systém Linux tak pro 
Windows. V současnosti tak máme k dispozici každodenní instalační balíčky pro 
Linux i Windows sestavené z aktuálního stavu vývojové větve.  Tyto poměrně 
zásadní změny si vyžádaly poměrně dost času na zvládnutí nových nástrojů a 
zaškolení týmu, výsledkem však je  infrastruktura, která nám v následujících 
letech umožní efektivně produkovat výkonný a spolehlivý software.


\begin{thebibliography}{99}

\bibitem{ern2010guaranteed}
A. Ern, A.F. Stephansen, M. Vohral{\'\i}k.
Guaranteed and robust discontinuous Galerkin a posteriori error estimates for convection--diffusion--reaction problems,
\emph{Journal of computational and applied mathematics}, 234(1):114--130, 2010.


\bibitem{ern_stephansen_zunino}
A. Ern, A.F. Stephansen, P. Zunino.
A discontinuous {G}alerkin method with weighted averages for advection--diffusion equations with locally small and anisotropic diffusivity,
\emph{IMA Journal of Numerical Analysis}, 29(2):235--256, 2009.


\bibitem{martin_modeling_2005}
V. Martin, J. Jaffr{\'e}, J.E. Roberts.
Modeling Fractures and Barriers as Interfaces for Flow in Porous Media,
\emph{{SIAM} Journal on Scientific Computing}, 26(5):1667--1691, 2005.


\bibitem{SistekBDDC}
J. Šístek, J. Březina, B. Sousedík : BDDC for Mixed-Hybrid 
Formulation of Flow in Porous Media with Combined Mesh Dimensions, Numer. Linear 
Algebra Appl. (submitted)
\end{thebibliography}




\end{document}